name: Core Brain AutoFix (No-404)

on:
  push:
    branches: ["main"]
  schedule:
    - cron: "*/10 * * * *"
  workflow_dispatch:

env:
  DOMAIN: tradehub.ssgpt6.com
  CF_ZONE_NAME: ssgpt6.com
  CF_RECORD_NAME: tradehub
  CF_RECORD_TARGET: cname.vercel-dns.com
  VERCEL_PROJECT_NAME: tradehub-ssgpt6-com
  VERCEL_TEAM_SLUG: arifur-shantas-projects

jobs:
  autofix:
    runs-on: ubuntu-latest
    steps:
      - name: Quick status check (domain)
        id: check
        run: |
          set +e
          code=$(curl -s -o /dev/null -w "%{http_code}" "https://${DOMAIN}/?fresh=1")
          echo "http_code=$code" >> $GITHUB_OUTPUT
          echo "Domain status code: $code"
          exit 0

      - name: Fix if not healthy (attach domain + fix DNS + purge cache)
        if: steps.check.outputs.http_code != '200'
        env:
          VERCEL_TOKEN: ${{ secrets.VERCEL_TOKEN }}
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
        run: |
          set -euo pipefail

          if [ -z "${VERCEL_TOKEN:-}" ]; then
            echo "Missing secret: VERCEL_TOKEN"; exit 1
          fi
          if [ -z "${CLOUDFLARE_API_TOKEN:-}" ]; then
            echo "Missing secret: CLOUDFLARE_API_TOKEN"; exit 1
          fi

          echo "Step A) Find Vercel Team ID for slug: ${VERCEL_TEAM_SLUG}"
          team_id=$(curl -sS -H "Authorization: Bearer ${VERCEL_TOKEN}" \
            "https://api.vercel.com/v2/teams" | \
            node -e 'let d="";process.stdin.on("data",c=>d+=c);process.stdin.on("end",()=>{const j=JSON.parse(d);const t=(j.teams||[]).find(x=>x.slug===process.env.VERCEL_TEAM_SLUG); if(!t){process.exit(2)} console.log(t.id);})')
          echo "Vercel team_id: $team_id"

          echo "Step B) Find Vercel Project ID by name: ${VERCEL_PROJECT_NAME}"
          project_id=$(curl -sS -H "Authorization: Bearer ${VERCEL_TOKEN}" \
            "https://api.vercel.com/v9/projects/${VERCEL_PROJECT_NAME}?teamId=${team_id}" | \
            node -e 'let d="";process.stdin.on("data",c=>d+=c);process.stdin.on("end",()=>{const j=JSON.parse(d); if(!j.id){process.exit(3)} console.log(j.id);})')
          echo "Vercel project_id: $project_id"

          echo "Step C) Ensure domain is attached to Vercel project"
          curl -sS -X POST \
            -H "Authorization: Bearer ${VERCEL_TOKEN}" \
            -H "Content-Type: application/json" \
            "https://api.vercel.com/v10/projects/${project_id}/domains?teamId=${team_id}" \
            --data "{\"name\":\"${DOMAIN}\"}" >/dev/null || true

          echo "Step D) Cloudflare: find zone id for ${CF_ZONE_NAME}"
          zone_id=$(curl -sS -H "Authorization: Bearer ${CLOUDFLARE_API_TOKEN}" \
            -H "Content-Type: application/json" \
            "https://api.cloudflare.com/client/v4/zones?name=${CF_ZONE_NAME}" | \
            node -e 'let d="";process.stdin.on("data",c=>d+=c);process.stdin.on("end",()=>{const j=JSON.parse(d); const z=(j.result||[])[0]; if(!z){process.exit(4)} console.log(z.id);})')
          echo "Cloudflare zone_id: $zone_id"

          echo "Step E) Cloudflare: upsert CNAME ${CF_RECORD_NAME}.${CF_ZONE_NAME} -> ${CF_RECORD_TARGET}"
          record_name="${CF_RECORD_NAME}.${CF_ZONE_NAME}"

          existing=$(curl -sS -H "Authorization: Bearer ${CLOUDFLARE_API_TOKEN}" \
            -H "Content-Type: application/json" \
            "https://api.cloudflare.com/client/v4/zones/${zone_id}/dns_records?type=CNAME&name=${record_name}")

          record_id=$(echo "$existing" | node -e 'let d="";process.stdin.on("data",c=>d+=c);process.stdin.on("end",()=>{const j=JSON.parse(d); const r=(j.result||[])[0]; if(r&&r.id) console.log(r.id);})')

          payload=$(cat <<JSON
          {
            "type": "CNAME",
            "name": "${CF_RECORD_NAME}",
            "content": "${CF_RECORD_TARGET}",
            "ttl": 300,
            "proxied": false
          }
JSON
          )

          if [ -n "${record_id:-}" ]; then
            echo "Updating existing record id: $record_id"
            curl -sS -X PATCH \
              -H "Authorization: Bearer ${CLOUDFLARE_API_TOKEN}" \
              -H "Content-Type: application/json" \
              "https://api.cloudflare.com/client/v4/zones/${zone_id}/dns_records/${record_id}" \
              --data "$payload" >/dev/null
          else
            echo "Creating new record"
            curl -sS -X POST \
              -H "Authorization: Bearer ${CLOUDFLARE_API_TOKEN}" \
              -H "Content-Type: application/json" \
              "https://api.cloudflare.com/client/v4/zones/${zone_id}/dns_records" \
              --data "$payload" >/dev/null
          fi

          echo "Step F) Purge Cloudflare cache (purge everything)"
          curl -sS -X POST \
            -H "Authorization: Bearer ${CLOUDFLARE_API_TOKEN}" \
            -H "Content-Type: application/json" \
            "https://api.cloudflare.com/client/v4/zones/${zone_id}/purge_cache" \
            --data '{"purge_everything":true}' >/dev/null

          echo "Step G) Re-test domain (wait a bit, then check)"
          sleep 20
          code2=$(curl -s -o /dev/null -w "%{http_code}" "https://${DOMAIN}/?fresh=2")
          echo "After fix, domain status code: $code2"
          if [ "$code2" != "200" ]; then
            echo "Still not 200. The agent will try again on next run."
            exit 0
          fi

          echo "âœ… Domain is now healthy (200)."

      - name: Final check output
        run: |
          code=$(curl -s -o /dev/null -w "%{http_code}" "https://${DOMAIN}/?fresh=final")
          echo "FINAL domain status code: $code"